name: Release Docker

on:
  push:
    tags:
      - 'v*.*.*'
  schedule:
    - cron: '0 0 * * *' # Every day at midnight
  workflow_dispatch: # Allow manual trigger
    inputs:
      version:
        description: 'Flutter version to build (e.g., 3.35.0). Leave empty for latest stable.'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1

      - name: Determine Target Version
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # Tag format: v<flutter_version>.<timestamp>
            FULL_TAG=${GITHUB_REF_NAME#v}
            FLUTTER_VERSION=$(echo $FULL_TAG | cut -d'.' -f1-3)
            DOCKER_TAG=${FULL_TAG}
            echo "found=true" >> $GITHUB_OUTPUT
            echo "source=tag" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            # Manual trigger with specific version
            VERSION=${{ github.event.inputs.version }}
            TIMESTAMP=$(date +'%Y%m%d%H%M%S')
            echo "found=true" >> $GITHUB_OUTPUT
            echo "source=auto" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "docker_tag=${VERSION}.${TIMESTAMP}" >> $GITHUB_OUTPUT
          else
            # Cron or Manual without version: Check for new releases
            NEW_VER=$(dart scripts/check_versions.dart)
            if [[ $NEW_VER == NEW_VERSION=* ]]; then
              VERSION=${NEW_VER#NEW_VERSION=}
              TIMESTAMP=$(date +'%Y%m%d%H%M%S')
              echo "found=true" >> $GITHUB_OUTPUT
              echo "source=auto" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "docker_tag=${VERSION}.${TIMESTAMP}" >> $GITHUB_OUTPUT
            else
              echo "found=false" >> $GITHUB_OUTPUT
              echo "No new version to build."
            fi
          fi

      - name: Set Environment Variables
        if: steps.target.outputs.found == 'true'
        run: |
          if [[ "${{ steps.target.outputs.source }}" == "tag" ]]; then
            # From tag push
            FULL_TAG=${GITHUB_REF_NAME#v}
            echo "FLUTTER_VERSION=$(echo $FULL_TAG | cut -d'.' -f1-3)" >> $GITHUB_ENV
            echo "DOCKER_TAG=$FULL_TAG" >> $GITHUB_ENV
          else
            # From auto check
            echo "FLUTTER_VERSION=${{ steps.target.outputs.version }}" >> $GITHUB_ENV
            echo "DOCKER_TAG=${{ steps.target.outputs.docker_tag }}" >> $GITHUB_ENV
          fi

      - name: Generate Dockerfile
        if: steps.target.outputs.found == 'true'
        run: |
          cat <<EOF > Dockerfile
          ARG FLUTTER_VERSION=${{ env.FLUTTER_VERSION }}
          FROM ghcr.io/cirruslabs/flutter:\${FLUTTER_VERSION}
          LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
          LABEL org.opencontainers.image.description="Flutter and Fastlane build environment"
          ENV LC_ALL=C.UTF-8 \
              LANG=C.UTF-8 \
              ANDROID_SDK_ROOT=/opt/android-sdk-linux \
              ANDROID_HOME=/opt/android-sdk-linux \
              PATH=\$PATH:\$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:\$ANDROID_SDK_ROOT/platform-tools \
              DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y --no-install-recommends \
          ruby ruby-dev git wget unzip ca-certificates curl xz-utils zip \
          openjdk-17-jre-headless && \
          gem install fastlane -NV && \
          yes | sdkmanager --licenses && \
          sdkmanager --install "platform-tools" "build-tools;35.0.0" "platforms;android-35" "cmake;3.22.1" "ndk;27.0.12077973" && \
          flutter config --no-analytics && \
          flutter precache --android --ios --no-web && \
          apt-get purge -y ruby-dev && \
          apt-get autoremove -y && \
          apt-get clean && \
          rm -rf \$ANDROID_SDK_ROOT/emulator \$ANDROID_SDK_ROOT/system-images \$ANDROID_SDK_ROOT/patcher \$ANDROID_SDK_ROOT/extras && \
          rm -rf /usr/lib/ruby/gems/*/cache /root/.pub-cache && \
          rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.cache /usr/share/doc /usr/share/man
          WORKDIR /app
          CMD ["bash"]
          EOF

      - name: Login to GHCR
        if: steps.target.outputs.found == 'true'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        if: steps.target.outputs.found == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/flutter-fastlane:${{ env.FLUTTER_VERSION }}
            ghcr.io/${{ github.repository_owner }}/flutter-fastlane:${{ env.DOCKER_TAG }}
          build-args: |
            FLUTTER_VERSION=${{ env.FLUTTER_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Post-Build Release (Auto-Release only)
        if: steps.target.outputs.found == 'true' && steps.target.outputs.source == 'auto'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update docker_config.json
          echo "{\"flutter_version\": \"${{ env.FLUTTER_VERSION }}\", \"docker_tag\": \"${{ env.DOCKER_TAG }}\"}" > docker_config.json
          git add docker_config.json
          git commit -m "Auto-release: ${{ env.DOCKER_TAG }}"
          git push
          
          # Tag and push
          git tag -a "v${{ env.DOCKER_TAG }}" -m "Auto-release ${{ env.DOCKER_TAG }}"
          git push origin "v${{ env.DOCKER_TAG }}"
